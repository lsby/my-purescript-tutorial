# 包管理机制

在继续之前需要说明这个语言的包管理机制.

就像之前看到的, 我们用的包管理器叫`spago`, 文档在这里: https://github.com/purescript/spago.

其实这个语言之前还用过两款包管理器, 一个是`bower`, 一个是`psc-package`, 但现在他们新写了`spago`.

这里介绍一些个人认为的核心概念, 但你需要先完整阅读文档.

## 包集

它有一个概念, 叫包集(package-sets), 是一个列表, 里面记录了每个插件的依赖, git仓库, 版本.

你的一个项目就对应一个包集, 你安装库的时候都是从包集这个列表里安装的.

比如我现在用的这个项目, 包集是:

```shell
https://github.com/purescript/package-sets/releases/download/psc-0.14.3-20210722/packages.dhall
```

如果你需要的某个库的版本比包集的旧怎么办? 那你可以用以前的包集.

每个包集可以保证其内部的包的版本正确, 不会冲突.

## 管理

在你的项目里可以看到两个文件, `packages.dhall`和`spago.dhall`.

前者用来定义包集的地址, 同时你也可以在这里加入一些自己的包或本地的包, 同时可以验证本地的包是否和包集有冲突.

后者则是记录你的项目引用了什么依赖, 当你build时, spago就会依据名字去包集里找git的地址来下载.

## 实例

这里演示如何使用一个失维的包.

因为是小众语言, 因为种种原因, 一些库并不可以被spago安装, 比如jquery的封装: https://pursuit.purescript.org/packages/purescript-jquery/5.0.0.

可以看到他还是用bower来安装的, 但我们可以尝试修复它.

首先先进入它的github页面, 看看issue发现作者也不维护它了, 但是代码还能用, 把它下载下来.

然后依据包管理器的说明, 对于旧版项目, 只需要只是spago init就可以把他转换为新版项目.

```shell
$ spago init
[info] Initializing a sample project or migrating an existing one..
[info] Found a "psc-package.json" file, migrating to a new Spago config..
[warn] Some of the dependencies you tried to add were not found in the package-set.
Not adding any new dependencies to your new spago config.
We didn't find:
- dom
- eff
- generics
- monoid
- proxy

[info] Updating package-set tag to "psc-0.14.3-20210722"
Fetching the new one and generating hashes.. (this might take some time)
[info] Generating new hashes for the package set file so it will be cached.. (this might take some time)
[info] Found existing directory "src", skipping copy of sample sources
[info] Found existing directory "test", skipping copy of sample sources
[info] Found existing file ".gitignore", not overwriting it
[info] Set up a local Spago project.
[info] Try running `spago build`
```

可以看到他选择了一个包集, 同时也生成了`packages.dhall`文件和`spago.dhall`.

然后让你运行spago build试试.

接下来:

```shell
Error 1 of 6:

  in module JQuery
  at src\JQuery.purs:61:1 - 61:57 (line 61, column 1 - line 61, column 57)

    Module Foreign was not found.
    Make sure the source file exists, and that it has been provided as an input to the compiler.

...
```

可以看到是缺了几个依赖包, 我们可以看它原来依赖的是什么, 给他补上.

看看`bower.json`文件, 里面写着它之前的依赖, `web-dom`, `effect`, `foreign`. 同时有版本号.

如果我们要还原以前的版本号, 就必须降低包集, 但这些版本实在太古老了, 我们就用目前包集的新版试试把.

于是不改变包集地址, 只是将依赖写到`spago.dhall`文件:

```
{ name = "jquery"
, dependencies = [ "console", "effect", "prelude", "psci-support", "web-dom", "foreign" ]
, packages = ./packages.dhall
, sources = [ "src/**/*.purs", "test/**/*.purs" ]
}
```

再build试试:

```haskell
[info] Build succeeded.
[warn] None of your project files import modules from some projects that are in the direct dependencies of your project.
These dependencies are unused. To fix this warning, remove the following packages from the list of dependencies in your config:   
- web-dom
[error] Some of your project files import modules from packages that are not in the direct dependencies of your project.
To fix this error add the following packages to the list of dependencies in your config:
- foldable-traversable
- maybe
- partial
- transformers
You may add these dependencies by running the following command:
spago install foldable-traversable maybe partial transformers
```

他说, 一个是`web-dom`这个依赖没有用到, 可以删掉, 另一个是下面这几个依赖用到了, 需要添加. 那么就按他说的做.

```
{ name = "jquery"
, dependencies =
  [ "console"
  , "effect"
  , "foldable-traversable"
  , "foreign"
  , "maybe"
  , "partial"
  , "prelude"
  , "psci-support"
  , "transformers"
  ]
, packages = ./packages.dhall
, sources = [ "src/**/*.purs", "test/**/*.purs" ]
}
```

再次构建, 就完成了.

接下来回到我们的项目, 增加一个本地依赖(packages.dhall文件)(这个似乎只支持相对路径, 所以先把它考到项目路径下):

```
let upstream =
      https://github.com/purescript/package-sets/releases/download/psc-0.14.1-20210516/packages.dhall sha256:f5e978371d4cdc4b916add9011021509c8d869f4c3f6d0d2694c0e03a85046c8

in  upstream
  with jquery = ./purescript-jquery as Location
```

build一下可以看到成功:

```haskell
$ spago build
Compiling JQuery
Compiling Foreign.Keys
Compiling Foreign.Index
Compiling Main
[info] Build succeeded.
```

通过`spago ls packages`查看包, 也可以看到本地包:

```shell
...
integers                         v5.0.0    Remote "https://github.com/purescript/purescript-integers.git"
interpolate                      v2.0.1    Remote "https://github.com/jordanmartinez/purescript-interpolate.git"
invariant                        v5.0.0    Remote "https://github.com/purescript/purescript-invariant.git"
jquery                           local     Local "./purescript-jquery"
js-date                          v7.0.0    Remote "https://github.com/purescript-contrib/purescript-js-date.git"
js-fileio                        v2.2.0    Remote "https://github.com/newlandsvalley/purescript-js-fileio.git"
js-timers                        v5.0.1    Remote "https://github.com/purescript-contrib/purescript-js-timers.git"
...
```

接下来运行验证程序:

```haskell
$ spago verify jquery
[info] Verifying 1 packages, this might take a while..
[info] Verifying package "jquery"
[info] Build succeeded.
[info] Successfully verified "jquery"
```

应该没问题了, 那么在`spago.dhall`加入依赖, build, 就可以使用这个包了.

当然, 对于这个包, 你可以把他提交到官方的包集, 或者传到自己的github上, 下次就可以通过spago安装了.

这个作者似乎也在寻找维护者, 读到这里的你也可以去试试.

